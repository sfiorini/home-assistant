<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="state-card.html">

<polymer-element name="states-cards" attributes="api filter">
  <template>
    <style>
    :host {
      display: block;
      width: 100%;
    }

    state-card, state-add-card {
      display: inline-block;
      width: 350px;
      margin: 10px 0 0 10px;      
    }

    state-add-card {
      cursor: pointer;
    }

    </style>

    <div horizontal layout wrap>
      <template repeat="{{state in states}}">
        <state-card
          entity="{{state.entity_id}}"
          state="{{state.state}}"
          last_changed="{{state.last_changed}}"
          state_attr="{{state.attributes}}"
          cb_turn_on="{{api.turn_on}}"
          cb_turn_off="{{api.turn_off}}"
          cb_edit={{editCallback}}>
        </state-card>
      </template>

    </div>
  </template>
  <script>
  Polymer({
    raw_states: [],
    states: [],
    filter: null,
    filter_state: null,
    filter_substates: null,

    filterChanged: function(oldVal, newVal) {
      this.refilterStates();
    },

    ready: function() {
      this.editCallback = this.editCallback.bind(this);
    },

    domReady: function() {
      this.raw_states = this.api.states

      this.api.addEventListener('states-updated', this.statesUpdated.bind(this))

      this.refilterStates();
    },

    statesUpdated: function() {
      this.raw_states = this.api.states;

      this.refilterStates();
    },

    refilterStates: function() {
      if(this.filter == null) {
        this.states = this.raw_states;

      } else {
        var filter_state = this.api.getState(this.filter);

        var map_states = function(entity_id) {
          return this.api.getState(entity_id);
        }.bind(this)

        // take the parent state and append it's children
        this.states = [filter_state].concat(
          filter_state.attributes.entity_id.map(map_states))
      }
    },

    editCallback: function(entityId) {
      this.api.showEditStateDialog(entityId);
    },

  });
  </script>
</polymer-element>

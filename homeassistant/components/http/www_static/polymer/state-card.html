<script src="bower_components/moment/moment.js"></script>
<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/core-tooltip/core-tooltip.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">

<polymer-element name="state-card"
  attributes="entity state last_changed state_attr cb_turn_on, cb_turn_off cb_edit">
  <template>
    <style>
    :host {
      position: relative;
      background-color: white;
      padding: 20px 20px 55px 20px;
      width: 100%;
      border-radius: 2px;
    }

    .header {
      text-transform: capitalize;
      
      font-weight: 300;

      font-size: 1.5rem;
    }

    .subheader {
      margin-top: -5px;
      color: darkgrey;
    }

    .state-attributes {
      margin-top: 10px;
      font-size: 1rem;
    }

    .state-attributes .key {
      white-space: nowrap;
      width: 85px;
      float: left;
      clear: left;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .state-attributes .value {
      margin-left: 95px;
    }

    .actions {
      position: absolute;
      bottom: 10px;
      left: 20px;
      right: 20px;

      text-align: right;
    }

    paper-button.toggle {
      color: #03a9f4;
    }

    </style>

    <div class="header" horizontal justified layout>
      <span class="entity_id">
        <template if="{{state_attr['friendly_name']}}">{{state_attr['friendly_name']}}</template>
        <template if="{{!state_attr['friendly_name']}}">{{entity_id | makeReadable}}</template>
      </span>
      <span class='state'>{{state | makeReadable}}</span>
    </div>

    <div class="subheader" horizontal justified layout>
      <span class="domain">{{domain}}</span>
      <core-tooltip label="{{last_changed}}" position="bottom">
        <span class="last_changed_from_now">{{last_changed_from_now}}</span>
      </core-tooltip>
    </div>
    

    <div class="state-attributes">
      <template repeat="{{key in objectKeys(state_attr)}}">
        <template if="{{key != 'friendly_name'}}">
          <div class='key'>{{key | makeReadable}}</div>
          <div class='value'>{{state_attr[key] | makeReadable}}</div>
        </template>
      </template>
    </div>

    <div class="actions">
      <paper-button class='edit' on-click="{{editClicked}}">EDIT</paper-button>

      <template if="{{state == 'on'}}">
        <paper-button class="toggle" on-click="{{turn_off}}">TURN OFF</paper-button>
      </template>
      <template if="{{state == 'off'}}">
        <paper-button class="toggle" on-click="{{turn_on}}">TURN ON</paper-button>
      </template>
    </div>

  </template>
  <script>
  Polymer({
    // attributes
    entity: "",
    state: "",
    last_changed: "never",
    state_attr: {},
    cb_turn_on: null,
    cb_turn_off: null,
    cb_edit: null,

    // computed
    domain: "",
    entity_id: "",

    entityChanged: function(oldVal, newVal) {
      var parts = newVal.split(".")

      if(parts.length == 1) {
        this.domain = ""
        this.entity_id = parts[0]
      } else {
        this.domain = parts[0]
        this.entity_id = parts.slice(1).join('.')
      }
    },

    last_changedChanged: function(oldVal, newVal) {
      this.last_changed_from_now = moment(this.last_changed, "HH:mm:ss DD-MM-YYYY").fromNow()
    },

    turn_on: function() {
      if(this.cb_turn_on) {
        this.cb_turn_on(this.entity);
      }
    },

    turn_off: function() {
      if(this.cb_turn_off) {
        this.cb_turn_off(this.entity);
      }
    },

    editClicked: function() {
      if(this.cb_edit) {
        this.cb_edit(this.entity);
      }
    },

    // used as filter
    makeReadable: function(value) {
      if(typeof value == "string") {
        return value.replace(/_/g, " ");

      } else if(Array.isArray(value)) {
        return value.join(", ");

      } else {
        return value;
      }
    },

    objectKeys: function(obj) {
      return obj ? Object.keys(obj) : [];
    }
  });
  </script>
</polymer-element>

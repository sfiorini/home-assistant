<link rel="import" href="bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="bower_components/paper-fab/paper-fab.html">
<link rel="import" href="bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="bower_components/paper-tabs/paper-tab.html">

<link rel="import" href="states-cards.html">

<polymer-element name="home-assistant-main" attributes="api">
  <template>
    <style type="text/css">

      :host {
        font-family: 'RobotoDraft', sans-serif;
      }

      core-header-panel {
        height: 100%;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
        background-color: #E5E5E5;
      }

      core-toolbar {
        background: #03a9f4;
        font-size: 1.4rem;
        color: white;
      }

      .content {
        padding-bottom: 75px;
        padding-right: 10px;
      }

      paper-fab {
        position: fixed;
        bottom: 10px;
        right: 10px;
      }

    </style>


    <core-header-panel unresolved fullbleed>

      <core-toolbar class='medium-tall'>
        <div flex>
          Home Assistant
        </div>
        <core-icon-button icon="refresh" on-click="{{handleRefreshClick}}"></core-icon-button>
        <core-icon-button icon="developer-mode-tv" on-click="{{handleEventClick}}"></core-icon-button>
        <core-icon-button icon="settings-remote" on-click="{{handleServiceClick}}"></core-icon-button>

        <div class="bottom fit" horizontal layout>
            <paper-tabs id="tabsHolder" noink flex
                        selected="0" on-core-select="{{tabClicked}}">
            
              <paper-tab>ALL</paper-tab>

              <template repeat="{{state in api.states}}">
                <template if="{{isCustomGroup(state)}}">
                  <paper-tab data-entity="{{state.entity_id}}">{{state.entity_id | groupName}}</paper-tab>
                </template>
              </template>
                
            </paper-tabs>
        </div>
      </core-toolbar>

      <div class="content" flex>
        <states-cards api="{{api}}" filter="{{selectedTab}}"></states-cards>
        <paper-fab icon="add" on-click={{handleAddStateClick}}></paper-fab>
      </div>

    </core-header-panel>

  </template>
  <script>
  Polymer({
    selectedTab: null,

    isCustomGroup: function(state) {
      return (state.entity_id.lastIndexOf('group.') == 0 &&
              !state.attributes.auto);
    },

    groupName: function(entity_id) {
      return entity_id.substring(6).toUpperCase().replace(/_/g, " ");
    },

    tabClicked: function(ev) {
      if(ev.detail.isSelected) {
        // will be null for ALL tab
        this.selectedTab = ev.detail.item.getAttribute('data-entity');
      }
    },

    handleRefreshClick: function() {
      this.api.fetchStates();
    },

    handleEventClick: function() {
      this.api.showFireEventDialog();
    },

    handleServiceClick: function() {
      this.api.showCallServiceDialog();
    },

    handleAddStateClick: function() {
      this.api.showSetStateDialog();
    }

  });
  </script>  
</polymer-element>

<link rel="import" href="bower_components/font-roboto/roboto.html">
<link rel="import" href="home-assistant-main.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">

<polymer-element name="splash-login" attributes="auth">
  <template>
    <style type="text/css">

      :host {
        font-family: 'RobotoDraft', sans-serif;
        height: 100%;
        overflow: auto;
      }

      .login paper-button {
        margin-left: 242px;
      }

      .login .interact {
        height: 110px;
      }

    </style>

    <template if="{{state == 'no_auth'}}">
      <div layout horizontal center fit class='login'>
        <div layout vertical center flex>
          <img src="/static/favicon-192x192.png" />
          <h1>Home Assistant</h1>

          <div class='interact' layout vertical>
            <div id='loginform'>
              <paper-input id="passwordInput" label="Password" type="password" value="{{auth}}"></paper-input>
              <paper-button on-click={{validatePassword}}>Log In</paper-button>
            </div>

            <div id="validateMessage" hidden>Validating password...</div>
          </div>
        </div>
      </div>
    </template>
    <template if="{{state == 'valid_auth'}}">
      <home-assistant-main auth="{{auth}}"></home-assistant-main>
    </template>

  </template>
  <script>
  Polymer({

    // can be no_auth, test_auth, valid_auth
    state: "no_auth",
    auth: "",

    ready: function() {
    },

    domReady: function() {
      if(this.auth) {
        this.validatePassword();
      }
    },

    validatePassword: function() {
      this.$.passwordInput.commit();
      this.$.loginform.setAttribute('hidden', null)
      this.$.validateMessage.removeAttribute('hidden')

      var req = new XMLHttpRequest();
      req.open("GET", "/api/", true);
      req.setRequestHeader("HA-access", this.auth);

      req.onreadystatechange = function() {
        if(req.readyState == 4) {
          if(req.status == 200) {
            this.state = 'valid_auth'
          } else {
            this.auth = "";

            this.$.passwordInput.error = "Invalid Password";
            this.$.passwordInput.required = 1;

            this.$.loginform.removeAttribute('hidden');
            this.$.validateMessage.setAttribute('hidden', null);

            this.state = 'no_auth'
          }
        }
      }.bind(this)

      req.send();
    },

  });
  </script>  
</polymer-element>
